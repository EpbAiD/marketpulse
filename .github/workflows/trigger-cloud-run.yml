name: Trigger Cloud Run Training

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Training mode'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - train
          - inference
      features:
        description: 'Features to train (comma-separated, or "all")'
        required: false
        default: 'all'
      force_retrain:
        description: 'Force retrain even if models are fresh'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          # Cloud Run job is deployed in coms-452404, not regime01
          project_id: coms-452404

      - name: Enable Cloud Run API if needed
        run: |
          echo "ðŸ”§ Ensuring Cloud Run Admin API is enabled..."
          gcloud services enable run.googleapis.com --project=coms-452404 --quiet || echo "Note: API enablement may require additional permissions"

      - name: Trigger Cloud Run Job
        run: |
          echo "ðŸš€ Triggering Cloud Run GPU training job..."
          echo "Mode: ${{ inputs.mode }}"
          echo "Features: ${{ inputs.features }}"
          echo "Force Retrain: ${{ inputs.force_retrain }}"

          # Use ^ as separator to avoid conflicts with comma-separated feature list
          gcloud run jobs execute marketpulse-training \
            --region=us-central1 \
            --project=coms-452404 \
            --update-env-vars="^::^MODE=${{ inputs.mode }}::FEATURES=${{ inputs.features }}::FORCE_RETRAIN=${{ inputs.force_retrain }}"

          echo "âœ… Job triggered! Check Cloud Run console for status."
